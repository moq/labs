<Project>

  <PropertyGroup>
    <MoqAnalyzerDir Condition="'$(MSBuildRuntimeType)' == 'Full'">$(MSBuildThisFileDirectory)..\..\tools\net472</MoqAnalyzerDir>
    <MoqAnalyzerDir Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)..\..\tools\net5.0</MoqAnalyzerDir>
  </PropertyGroup>
  
  <!-- Stunts provides this property -->
  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true'">
    <CompilerVisibleProperty Include="DebugMoqSourceGenerator" />
    <CompilerVisibleProperty Include="EmitMoqSource" />
    <CompilerVisibleProperty Include="MoqAnalyzerDir" />
  </ItemGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true' and '$(MSBuildRuntimeType)' == 'Full' and '$(SkipCompilerExecution)' != 'true' and '$(DesignTimeBuild)' != 'true'">
    <Analyzer Include="$(MSBuildThisFileDirectory)..\..\tools\net472\Moq*.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true' and '$(MSBuildRuntimeType)' == 'Core' and '$(SkipCompilerExecution)' != 'true' and '$(DesignTimeBuild)' != 'true'">
    <Analyzer Include="$(MSBuildThisFileDirectory)..\..\tools\net5.0\Moq*.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true' and '$(RegisterStaticMockFactory)' != 'false'">
    <MockFactory Include="$(StaticMockFactory)" PackageId="Moq" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="@(Compile)">
      <!-- Hide Mock.cs/vb from the project -->
      <Visible Condition="'%(NuGetItemType)' == 'Compile' and '%(NuGetPackageId)' == 'Moq'">false</Visible>
    </Compile>
  </ItemGroup>

  <Target Name="GetMockFactoryAttributes" BeforeTargets="GetAssemblyAttributes" Returns="@(MockFactory)">
    <ItemGroup>
      <!-- This adds all factories unconditionally, since the specific factories 
           will actually check for duplicates and warn if needed. -->
      <AssemblyAttribute Include="Moq.MockFactoryAttribute" Condition="'%(MockFactory.Identity)' != ''">
        <_Parameter1>%(MockFactory.Identity)</_Parameter1>
        <_Parameter2>%(MockFactory.PackageId)</_Parameter2>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>

  <Import Project="Moq.DynamicProxy.targets" 
          Condition="('$(SourceGeneratorSupported)' != 'true' or '$(RegisterStaticMockFactory)' == 'false') and  Exists('Moq.DynamicProxy.targets')" />

</Project>